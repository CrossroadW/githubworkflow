name: test_linux_deploy
on:
  push:
  workflow_dispatch:

jobs:
  build_all:
    runs-on: ubuntu-latest
    steps:
      # 检出仓库
      - uses: actions/checkout@v4

      # 部署工具
      - name: Install LinuxDeploy
        id: install-linuxdeploy
        uses: miurahr/install-linuxdeploy-action@v1.8.0
        with:
          plugins: qt appimage
          
      - name: Install Qt (Windows)
        uses: jurplel/install-qt-action@v4
        with:
          version: "5.12.12"
          target: "desktop"
          arch: "win64_msvc2017_64"
          install-deps: true
          dir: ${{ github.workspace }}/Qt

      # 构建
      - name: Configure CMake
        shell: pwsh
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
          cmake --build build

      - name: Create application dir
        run: |
          mkdir -p appdir/usr/bin
          cp build/Release/bin/main appdir/usr/bin/
          ${{ steps.install-linuxdeploy.outputs.linuxdeploy }} \
            --output appimage \
            --plugin qt
            --executable appdir/usr/bin/main \
            --appdir appdir \
            --desktop-file GithubWorkFlow.desktop \
            --icon-file github-256x256.png

      - name: Upload AppImage
        uses: actions/upload-artifact@v5
        with:
          name: GithubWorkFlow
          path: GithubWorkFlow*.AppImage   