name: CMake Build with Ninja

on:
  push:
  workflow_dispatch:

jobs:
  # =========================
  # 1️⃣ 安装 Qt（并行 job）
  # =========================
  install_qt:
    runs-on: windows-latest
    outputs:
      QT_ROOT_DIR: ${{ steps.export.outputs.QT_ROOT_DIR }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt
        id: install-qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "5.12.12"
          target: desktop
          arch: "win64_msvc2017_64"
          install-deps: true

      # 手动导出环境变量为 job 输出
      - name: Export Qt root dir
        id: export
        shell: pwsh
        run: |
          echo "QT_ROOT_DIR=$env:QT_ROOT_DIR" >> $env:GITHUB_OUTPUT

  # =========================
  # 2️⃣ 安装 Boost（并行 job）
  # =========================
  install_boost:
    runs-on: windows-latest
    outputs:
      BOOST_ROOT: ${{ steps.install-boost.outputs.BOOST_ROOT }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Boost
        id: install-boost
        uses: MarkusJx/install-boost@v2
        with:
          boost_version: 1.89.0
          boost_install_dir: ${{ github.workspace }}/boost
          platform_version: 2022
          toolset: msvc

  # =========================
  # 3️⃣ 汇总输出（Qt + Boost）
  # =========================
  setup_merge:
    runs-on: windows-latest
    needs:
      - install_qt
      - install_boost
    outputs:
      QT_ROOT_DIR: ${{ needs.install_qt.outputs.QT_ROOT_DIR }}
      BOOST_ROOT: ${{ needs.install_boost.outputs.BOOST_ROOT }}
    steps:
      - run: echo "Merged Qt and Boost paths"

  # =========================
  # 4️⃣ 构建项目
  # =========================
  build:
    runs-on: windows-latest
    needs: setup_merge
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSVC Developer Command Prompt
        if: runner.os == 'Windows'
        uses: TheMrMilchmann/setup-msvc-dev@v4
        with:
          arch: x64

      - name: Configure CMake
        shell: pwsh
        run: |
          # 输出 Boost 目录结构
          Write-Host "===== Boost Directory ====="
          Get-ChildItem -Path "${env:BOOST_ROOT}" -Directory | Select-Object -First 5 | ForEach-Object {
              Write-Host $_.FullName
              Get-ChildItem -Path $_.FullName -Directory | Select-Object -First 5 | ForEach-Object {
                  Write-Host "  └─ $_"
                  Get-ChildItem -Path $_.FullName -Directory | Select-Object -First 5 | ForEach-Object {
                      Write-Host "      └─ $_"
                  }
              }
          }

          # 输出 Qt 目录结构
          Write-Host "===== Qt Directory ====="
          Get-ChildItem -Path "${env:QT_ROOT_DIR}" -Directory | Select-Object -First 5 | ForEach-Object {
              Write-Host $_.FullName
              Get-ChildItem -Path $_.FullName -Directory | Select-Object -First 5 | ForEach-Object {
                  Write-Host "  └─ $_"
                  Get-ChildItem -Path $_.FullName -Directory | Select-Object -First 5 | ForEach-Object {
                      Write-Host "      └─ $_"
                  }
              }
          }
          cmake -S . -B build -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_PREFIX_PATH="${{ needs.setup_merge.outputs.BOOST_ROOT }};${{ needs.setup_merge.outputs.QT_ROOT_DIR }}"

      - name: Build
        run: cmake --build build --parallel

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: build/main.exe
